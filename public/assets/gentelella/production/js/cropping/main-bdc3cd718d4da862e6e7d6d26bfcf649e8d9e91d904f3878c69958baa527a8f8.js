!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof exports?t(require("jquery")):t(jQuery)}(function(s){"use strict";function t(t){this.$container=t,this.$avatarView=this.$container.find(".avatar-view"),this.$avatar=this.$avatarView.find("img"),this.$avatarModal=this.$container.find("#avatar-modal"),this.$loading=this.$container.find(".loading"),this.$avatarForm=this.$avatarModal.find(".avatar-form"),this.$avatarUpload=this.$avatarForm.find(".avatar-upload"),this.$avatarSrc=this.$avatarForm.find(".avatar-src"),this.$avatarData=this.$avatarForm.find(".avatar-data"),this.$avatarInput=this.$avatarForm.find(".avatar-input"),this.$avatarSave=this.$avatarForm.find(".avatar-save"),this.$avatarBtns=this.$avatarForm.find(".avatar-btns"),this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper"),this.$avatarPreview=this.$avatarModal.find(".avatar-preview"),this.init(),r.log(this)}var r=window.console||{log:function(){}};t.prototype={constructor:t,support:{fileList:!!s('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs,this.support.formData||this.initIframe(),this.initTooltip(),this.initModal(),this.addListener()},addListener:function(){this.$avatarView.on("click",s.proxy(this.click,this)),this.$avatarInput.on("change",s.proxy(this.change,this)),this.$avatarForm.on("submit",s.proxy(this.submit,this)),this.$avatarBtns.on("click",s.proxy(this.rotate,this))},initTooltip:function(){this.$avatarView.tooltip({placement:"bottom"})},initModal:function(){this.$avatarModal.modal({show:!1})},initPreview:function(){var t=this.$avatar.attr("src");this.$avatarPreview.empty().html('<img src="'+t+'">')},initIframe:function(){var t="upload-iframe-"+(new Date).getTime(),a=s("<iframe>").attr({name:t,src:""}),i=this;a.one("load",function(){a.on("load",function(){var t;try{t=s(this).contents().find("body").text()}catch(a){r.log(a.message)}if(t){try{t=s.parseJSON(t)}catch(a){r.log(a.message)}i.submitDone(t)}else i.submitFail("Image upload failed!");i.submitEnd()})}),this.$iframe=a,this.$avatarForm.attr("target",t).after(a.hide())},click:function(){this.$avatarModal.modal("show"),this.initPreview()},change:function(){var t,a;this.support.datauri?0<(t=this.$avatarInput.prop("files")).length&&(a=t[0],this.isImageFile(a)&&(this.url&&URL.revokeObjectURL(this.url),this.url=URL.createObjectURL(a),this.startCropper())):(a=this.$avatarInput.val(),this.isImageFile(a)&&this.syncUpload())},submit:function(){return!(!this.$avatarSrc.val()&&!this.$avatarInput.val())&&(this.support.formData?(this.ajaxUpload(),!1):void 0)},rotate:function(t){var a;this.active&&(a=s(t.target).data()).method&&this.$img.cropper(a.method,a.option)},isImageFile:function(t){return t.type?/^image\/\w+$/.test(t.type):/\.(jpg|jpeg|png|gif)$/.test(t)},startCropper:function(){var i=this;this.active?this.$img.cropper("replace",this.url):(this.$img=s('<img src="'+this.url+'">'),this.$avatarWrapper.empty().html(this.$img),this.$img.cropper({aspectRatio:1,preview:this.$avatarPreview.selector,crop:function(t){var a=['{"x":'+t.x,'"y":'+t.y,'"height":'+t.height,'"width":'+t.width,'"rotate":'+t.rotate+"}"].join();i.$avatarData.val(a)}}),this.active=!0)},stopCropper:function(){this.active&&(this.$img.cropper("destroy"),this.$img.remove(),this.active=!1)},ajaxUpload:function(){var t=this.$avatarForm.attr("action"),a=new FormData(this.$avatarForm[0]),r=this;s.ajax(t,{type:"post",data:a,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){r.submitStart()},success:function(t){r.submitDone(t)},error:function(t,a,i){r.submitFail(a||i)},complete:function(){r.submitEnd()}})},syncUpload:function(){this.$avatarSave.click()},submitStart:function(){this.$loading.fadeIn()},submitDone:function(t){r.log(t),s.isPlainObject(t)&&200===t.state?t.result?(this.url=t.result,this.support.datauri||this.uploaded?(this.uploaded=!1,this.cropDone()):(this.uploaded=!0,this.$avatarSrc.val(this.url),this.startCropper()),this.$avatarInput.val("")):t.message&&this.alert(t.message):this.alert("Failed to response")},submitFail:function(t){this.alert(t)},submitEnd:function(){this.$loading.fadeOut()},cropDone:function(){this.$avatarForm.get(0).reset(),this.$avatar.attr("src",this.url),this.stopCropper(),this.$avatarModal.modal("hide")},alert:function(t){var a=['<div class="alert alert-danger avater-alert">','<button type="button" class="close" data-dismiss="alert">&times;</button>',t,"</div>"].join("");this.$avatarUpload.after(a)}},s(function(){return new t(s("#crop-avatar"))})});